<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6DOF Robot Arm Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        :root {
            --joint1-color: #FF5733;
            --joint2-color: #33FF57;
            --joint3-color: #3357FF;
            --joint4-color: #F033FF;
            --joint5-color: #FF33F0;
            --joint6-color: #33FFF0;
            --current-pos-color: #777;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .robot-arm {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .joint-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .joint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .joint-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .joint-values {
            display: flex;
            gap: 20px;
        }

        .joint-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1em;
            min-width: 60px;
            text-align: center;
        }

        .target-value {
            color: #2c3e50;
        }

        .current-value {
            color: var(--current-pos-color);
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .slider-label {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 3px;
        }

        .slider {
            width: 100%;
            height: 15px;
            border-radius: 8px;
            outline: none;
            -webkit-appearance: none;
        }

        /* Target slider styling */
        #joint1-target,
        #joint2-target,
        #joint3-target,
        #joint4-target,
        #joint5-target,
        #joint6-target {
            background: #e0e0e0;
        }

        /* Current position slider styling */
        #joint1-current,
        #joint2-current,
        #joint3-current,
        #joint4-current,
        #joint5-current,
        #joint6-current {
            background: #f0f0f0;
        }

        /* Joint-specific slider thumb colors */
        #joint1-target::-webkit-slider-thumb {
            background: var(--joint1-color);
        }

        #joint2-target::-webkit-slider-thumb {
            background: var(--joint2-color);
        }

        #joint3-target::-webkit-slider-thumb {
            background: var(--joint3-color);
        }

        #joint4-target::-webkit-slider-thumb {
            background: var(--joint4-color);
        }

        #joint5-target::-webkit-slider-thumb {
            background: var(--joint5-color);
        }

        #joint6-target::-webkit-slider-thumb {
            background: var(--joint6-color);
        }

        /* Current position indicator style */
        #joint1-current::-webkit-slider-thumb,
        #joint2-current::-webkit-slider-thumb,
        #joint3-current::-webkit-slider-thumb,
        #joint4-current::-webkit-slider-thumb,
        #joint5-current::-webkit-slider-thumb,
        #joint6-current::-webkit-slider-thumb {
            background: var(--current-pos-color);
            border: 2px solid white;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .limits {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
        }

        .control-panel {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            flex: 1;
        }

        button:hover {
            background-color: #2980b9;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }

        .hidden {
            display: none;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .duration-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }

        .duration-control label {
            font-size: 0.9em;
            color: #555;
        }

        .duration-control input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .control-panel {
            display: flex;
            align-items: center;
            margin-top: 30px;
            padding: 15px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            gap: 10px;
        }
    </style>
</head>

<body>
    <div id="connection-status" class="connection-status disconnected">Disconnected</div>

    <h1>6DOF Robot Arm Control</h1>

    <div class="robot-arm">
        <!-- Joint 1 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint1-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 1 (Base)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint1-target-value">0°</span>
                    <span class="joint-value current-value" id="joint1-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint1-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint1-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint1-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>

        <!-- Joint 2 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint2-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 2 (Shoulder)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint2-target-value">0°</span>
                    <span class="joint-value current-value" id="joint2-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint2-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint2-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint2-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>

        <!-- Joint 3 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint3-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 3 (Elbow)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint3-target-value">0°</span>
                    <span class="joint-value current-value" id="joint3-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint3-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint3-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint3-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>

        <!-- Joint 4 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint4-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 4 (Wrist Roll)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint4-target-value">0°</span>
                    <span class="joint-value current-value" id="joint4-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint4-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint4-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint4-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>

        <!-- Joint 5 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint5-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 5 (Wrist Pitch)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint5-target-value">0°</span>
                    <span class="joint-value current-value" id="joint5-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint5-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint5-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint5-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>

        <!-- Joint 6 -->
        <div class="joint-container" style="border-left: 4px solid var(--joint6-color);">
            <div class="joint-header">
                <span class="joint-name">Joint 6 (Wrist Yaw)</span>
                <div class="joint-values">
                    <span class="joint-value target-value" id="joint6-target-value">0°</span>
                    <span class="joint-value current-value" id="joint6-current-value">0°</span>
                </div>
            </div>
            <div class="slider-group">
                <div class="slider-container">
                    <div class="slider-label">Target Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint6-target">
                </div>
                <div class="slider-container">
                    <div class="slider-label">Current Position</div>
                    <input type="range" min="-180" max="180" value="0" class="slider" id="joint6-current" disabled>
                </div>
            </div>
            <div class="limits" id="joint6-limits">
                <span>-180°</span>
                <span>180°</span>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="duration-control">
            <label for="movement-duration">Movement Duration (s):</label>
            <input type="number" id="movement-duration" min="0.1" max="60" step="0.1" value="2.0">
        </div>
        <button id="send-command">Send Target Positions</button>
        <button id="reset-position">Reset Target Positions</button>
    </div>

    <div id="status-message" class="status hidden"></div>

    <script>
        // Initialize joint state
        const jointState = {
            targetValues: {
                joint1: 0,
                joint2: 0,
                joint3: 0,
                joint4: 0,
                joint5: 0,
                joint6: 0
            },
            limits: {
                joint1: { min: -180, max: 180 },
                joint2: { min: -180, max: 180 },
                joint3: { min: -180, max: 180 },
                joint4: { min: -180, max: 180 },
                joint5: { min: -180, max: 180 },
                joint6: { min: -180, max: 180 }
            }
        };

        // Connect to WebSocket with robust configuration
        const socket = io('http://localhost:5001', {
            transports: ['websocket'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: Infinity
        });

        // DOM elements
        const statusElement = document.getElementById('status-message');
        const connectionStatus = document.getElementById('connection-status');

        // Initialize sliders with limits
        function initializeSliders() {
            for (const [jointId, limit] of Object.entries(jointState.limits)) {
                const targetSlider = document.getElementById(`${jointId}-target`);
                const currentSlider = document.getElementById(`${jointId}-current`);
                const limitsDisplay = document.getElementById(`${jointId}-limits`);

                if (targetSlider) {
                    targetSlider.min = limit.min;
                    targetSlider.max = limit.max;
                    targetSlider.value = jointState.targetValues[jointId];
                }

                if (currentSlider) {
                    currentSlider.min = limit.min;
                    currentSlider.max = limit.max;
                }
                if (limitsDisplay) {
                    limitsDisplay.innerHTML = `<span>${limit.min}°</span><span>${limit.max}°</span>`;
                }

            }
        }

        // Update joint display
        function updateJointDisplay(jointId, value, isTarget = true) {
            const displayElement = document.getElementById(`${jointId}-${isTarget ? 'target' : 'current'}-value`);
            const sliderElement = document.getElementById(`${jointId}-${isTarget ? 'target' : 'current'}`);

            if (displayElement) {
                const displayValue = isTarget ? Math.round(value) : value.toFixed(2);
                displayElement.textContent = `${displayValue}°`;
            }

            if (sliderElement) {
                sliderElement.value = value;
            }

            if (isTarget) {
                jointState.targetValues[jointId] = value;
            }
        }

        // Initialize with fallback values
        document.addEventListener('DOMContentLoaded', () => {
            initializeSliders();

            // Set up event listeners for all target sliders
            document.querySelectorAll('.slider[id$="-target"]').forEach(slider => {
                const jointId = slider.id.replace('-target', '');
                updateJointDisplay(jointId, slider.value, true);

                slider.addEventListener('input', function () {
                    updateJointDisplay(jointId, this.value, true);
                });
            });
        });

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            connectionStatus.textContent = 'Connection Error';
            connectionStatus.className = 'connection-status error';
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status disconnected';
            if (reason === 'io server disconnect') {
                socket.connect();
            }
        });


        socket.on('init_state', (data) => {
            // Update limits if provided by server
            if (data.limits) {
                Object.assign(jointState.limits, data.limits);
                initializeSliders();
            }

            // Update current positions if provided
            if (data.positions) {
                Object.entries(data.positions).forEach(([jointId, value]) => {
                    updateJointDisplay(jointId, value, false);
                });
            }
        });

        socket.on('position_update', (positions) => {
            Object.entries(positions).forEach(([jointId, value]) => {
                updateJointDisplay(jointId, value, false);
            });
        });

        socket.on('status_update', (data) => {
            statusElement.textContent = data.message;
            statusElement.className = `status ${data.type}`;
            statusElement.style.display = 'block';
            setTimeout(() => { statusElement.style.display = 'none'; }, 3000);
        });

        // Button event handlers
        document.getElementById('send-command').addEventListener('click', () => {
            const durationInput = document.getElementById('movement-duration');
            const duration = parseFloat(durationInput.value);

            if (isNaN(duration) || duration <= 0) {
                statusElement.textContent = 'Please enter a valid duration (> 0)';
                statusElement.className = 'status error';
                statusElement.style.display = 'block';
                setTimeout(() => { statusElement.style.display = 'none'; }, 3000);
                return;
            }

            socket.emit('set_target_positions', {
                positions: jointState.targetValues,
                duration: duration
            });
        });

        document.getElementById('reset-position').addEventListener('click', () => {
            Object.keys(jointState.targetValues).forEach(jointId => {
                updateJointDisplay(jointId, 0, true);
            });
        });
    </script>
</body>

</html>